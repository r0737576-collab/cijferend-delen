<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Staartdeling — klassieke kolomopstelling (decimaal klaar)</title>

<style>
/* ============================================================
   BASIS
   ============================================================ */
:root{
  --ink:#000;
  --grid:#c8c8c8;
  --cell:38px;       /* standaard celbreedte (Excel-look) */
  --commaW:10px;     /* HEEL smalle komma-kolom */
  --vline:4px;       /* verticale dikke lijn */
  --bar:4px;         /* horizontale dikke lijn */
  --accent:#1f6feb;  /* focus */
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial;
  background:#f3f3f3; color:#000;
}

header, .toolbar{
  background:#fff; border-bottom:1px solid #ddd; padding:.8rem 1rem;
}
.toolbar{ display:flex; flex-wrap:wrap; gap:.6rem; align-items:center; }
.group{
  display:flex; gap:.4rem; align-items:center;
  background:#f1f1f1; border:1px solid #ddd; border-radius:.4rem;
  padding:.3rem .5rem;
}
button{
  padding:.45rem .7rem; border:1px solid #bbb; border-radius:.4rem; background:#fff; cursor:pointer;
}
button:hover{ border-color:#000; }

main{ padding:1rem; }
.board{
  background:#fff; border:1px solid #ddd; border-radius:.6rem; padding:1rem;
  max-width:980px; margin:auto;
}

/* ============================================================
   RASTER (Excel-look) voor deeltal, deler, quotiënt
   (We sturen de kolombreedtes aan met grid-template-columns via JS,
    zodat de komma-kolom super smal kan zijn.)
   ============================================================ */
.gridrow, .workRow{
  display:grid;
  /* grid-template-columns wordt in JS gezet (met smalle komma-kolom) */
}
.gridcell, .wcell{
  height:var(--cell);
  border-right:1px solid var(--grid);
  border-bottom:1px solid var(--grid);
  display:flex; align-items:center; justify-content:center;
  font-weight:600; font-size:1.2rem;
}
.gridrow { border:1px solid var(--grid); border-right:none; border-bottom:none; }
.gridcell:last-child, .wcell:last-child{ border-right:none; }
.gray{ color:#888; }

/* ============================================================
   LAYOUT: [leftSide(deeltal + werk)] | [vline] | [rightSide(div, bar, quot)]
   ============================================================ */
#gridWrapper{ display:flex; align-items:flex-start; gap:.2rem; }
#leftSide{ display:flex; flex-direction:column; gap:.6rem; }

/* verticale dikke lijn (midden) */
#vline{
  width:var(--vline); background:black;
  margin-left:.15rem; margin-right:.35rem; border-radius:2px;
  align-self:stretch;
}

/* rechterzijde: deler boven, daaronder bar en quotiënt */
#rightSide{
  display:flex; flex-direction:column; gap:.5rem; padding-top:.05rem;
}
#hbar{ height:var(--bar); background:black; border-radius:2px; }

/* ============================================================
   WERKGEDEELTE (klassiek, kolomopstelling, leeg & invulbaar)
   ============================================================ */
#workArea{ display:flex; flex-direction:column; gap:.15rem; }

/* Elke werkrij is een grid met exact dezelfde kolommen als links (incl. smalle komma-kolom) */
.workRow{ border-left:1px solid var(--grid); }
#workArea .workRow:first-child .wcell{ border-top:1px solid var(--grid); }

/* contenteditable cellen */
.wcell[contenteditable="true"], .gridcell[contenteditable="true"]{
  outline:none; caret-color: var(--ink);
}
.wcell[contenteditable="true"]:focus,
.gridcell[contenteditable="true"]:focus{
  box-shadow: inset 0 0 0 2px var(--accent);
  background:#f7fbff;
}

/* Trekstreep (aftreklijn) verschijnt pas in de REST-rij (onder product) */
.wcell.topline{ position:relative; }
.wcell.topline::before{
  content:"";
  position:absolute; left:-1px; right:-1px; top:-2px;
  border-top:3px solid #000;
}

/* Print */
@media print{
  header,.toolbar{ display:none !important; }
  main{ padding:0 }
  .board{ border:none }
}
</style>
</head>

<body>

<header>
  <h1>Staartdeling</h1>
</header>

<!-- KNOPPENBALK (niet aanpassen) -->
<div class="toolbar">
  <div class="group">
    <label><input type="radio" name="rest" value="zonder" checked> uitkomst</label>
    <label><input type="radio" name="rest" value="met"> met rest</label>
  </div>

  <div class="group"><label><input type="checkbox" id="toDecimals"> tot 0,001</label></div>
  <div class="group"><label><input type="checkbox" id="enableCheck"> controle</label></div>

  <button id="btnNew">Nieuwe oefening</button>
  <button id="btnCheck">Nakijken</button>
  <button id="btnSolution">Oplossing</button>
  <button id="btnReset">Wissen</button>
</div>

<main>
  <section class="board">
    <div id="gridWrapper">

      <!-- LINKS: deeltal + werk -->
      <div id="leftSide">
        <!-- Deeltal -->
        <div id="grid" class="gridrow"></div>

        <!-- Werkgebied (dynamisch #rijen; leeg & invulbaar) -->
        <div id="workArea"></div>
      </div>

      <!-- MIDDEN: verticale dikke lijn -->
      <div id="vline"></div>

      <!-- RECHTS: deler + horizontale lijn + quotiënt -->
      <div id="rightSide">
        <div id="divGrid" class="gridrow"></div>
        <div id="hbar"></div>
        <div id="quotGrid" class="gridrow"></div>
      </div>

    </div>
  </section>
</main>

<script>
/* ============================================================
   JAVASCRIPT – decimaal-geschikte layout
   ============================================================ */
(function(){

  const rnd = (a,b)=>Math.floor(Math.random()*(b-a+1))+a;
  const $  = s => document.querySelector(s);

  const settings = { dividendMax: 10000, divisorMax: 20 };

  /* ---------- Helpers voor kolomsjablonen ---------- */
  function buildTemplateCols(intLen, useDecimals, decSlots){
    // Maakt een grid-template-columns string met smalle komma-kolom
    // Voorbeeld (intLen=4, useDecimals=true, decSlots=3):
    // "var(--cell) var(--cell) var(--cell) var(--cell) var(--commaW) var(--cell) var(--cell) var(--cell)"
    const cols = [];
    for(let i=0;i<intLen;i++) cols.push('var(--cell)');
    if (useDecimals){
      cols.push('var(--commaW)');
      for(let i=0;i<decSlots;i++) cols.push('var(--cell)');
    }
    return cols.join(' ');
  }

  /* ---------- Genereer oefening ---------- */
  function generateProblem(wantNoRemainder){
    let divisor = rnd(2, settings.divisorMax);
    let dividend;
    if (wantNoRemainder){
      const q = rnd(2, Math.max(2, Math.floor(settings.dividendMax/divisor)));
      dividend = divisor*q;   // komt uit
    }else{
      dividend = rnd(2, settings.dividendMax);
      if (dividend % divisor === 0) dividend += 1; // verzeker rest
    }
    // Hier zou je in de toekomst een opgave mét decimalen kunnen genereren als string "123,45".
    // Voor nu is de opgave een geheel getal → origDecCount = 0 (zie computeExtraRows).
    return { dividend, divisor, origDecCount: 0 };
  }

  /* ---------- Raster helpers ---------- */
  function clear(n){ n.innerHTML=''; }

  // Deeltal links → retour: intLen + (useDecimals ? 1 + decSlots : 0)
  function buildDividendGrid(node, dividend, useDecimals, decSlots){
    clear(node);
    const s = String(dividend);
    const intLen = s.length;

    // grid-template-columns met smalle komma-kolom (als decimaalmodus actief)
    node.style.gridTemplateColumns = buildTemplateCols(intLen, useDecimals, decSlots);

    // Integere cijfers
    for(const ch of s){
      const c=document.createElement('div'); c.className='gridcell'; c.textContent=ch; node.appendChild(c);
    }
    // Eventueel komma + decimaalvakjes (grijze nullen als leidraad)
    if (useDecimals){
      const comma=document.createElement('div'); comma.className='gridcell'; comma.textContent=','; node.appendChild(comma);
      for(let i=0;i<decSlots;i++){
        const z=document.createElement('div'); z.className='gridcell gray'; z.textContent='0'; node.appendChild(z);
      }
    }
    // Visueel #kolommen links
    return intLen + (useDecimals ? 1 + decSlots : 0);
  }

  function buildDivisorGrid(node, divisor){
    clear(node);
    const s = String(divisor);
    // Deler kent geen komma-kolom → template = intLen × var(--cell)
    node.style.gridTemplateColumns = buildTemplateCols(s.length, false, 0);
    for(const ch of s){
      const c=document.createElement('div');
      c.className='gridcell';
      c.textContent=ch;
      node.appendChild(c);
    }
  }

  // Quotiënt-raster → contenteditable + komma-cel
  function buildQuotGrid(node, intLen, useDecimals, decSlots){
    clear(node);
    // sjabloon met smalle komma-kolom (op gelijke positie als links)
    node.style.gridTemplateColumns = buildTemplateCols(intLen, useDecimals, decSlots);

    // Integere quotiënt-cellen (leeg & invulbaar: enkel cijfers)
    for(let i=0;i<intLen;i++){
      node.appendChild(makeEditableCell('digit'));
    }
    if (useDecimals){
      // Komma-cel: invulbaar, accepteert alleen ',' of '.'
      node.appendChild(makeEditableCell('comma'));
      // Decimale quotiënt-cellen (leeg & invulbaar: enkel cijfers)
      for(let i=0;i<decSlots;i++){
        node.appendChild(makeEditableCell('digit'));
      }
    }

    // Zet horizontale bar exact zo breed als de quotiënt-grid
    const widths = getComputedStyle(node).getPropertyValue('grid-template-columns')
      .trim().split(/\s+/);
    const px = widths.map(w=> {
      // verwacht "var(--cell)" of "var(--commaW)" → vraag de uitgewerkte px-oppervlakte op
      // Fallback: probeer getComputedStyle op fictief element is duur; we nemen hier de offsetWidth van node.
      // Simpeler: meet totale breedte van node na render:
      return 0;
    });
    // Beter: gebruik de echte renderbreedte van de grid:
    // Kleine timeout om layout te laten renderen
    setTimeout(()=>{ document.getElementById('hbar').style.width = node.getBoundingClientRect().width + 'px'; }, 0);
  }

  function makeEditableCell(kind){
    const c = document.createElement('div');
    c.className = 'gridcell';
    c.setAttribute('contenteditable','true');

    c.addEventListener('beforeinput', (e)=>{
      const isDigit = e.inputType === 'insertText' && /^[0-9]$/.test(e.data || '');
      const isComma = e.inputType === 'insertText' && (e.data === ',' || e.data === '.');

      if (kind === 'digit'){
        if (isDigit) return;          // ok
        if (isComma) { e.preventDefault(); return; } // geen komma in digit-cel
        // laat backspace, delete, arrows toe
        if (['deleteContentBackward','deleteContentForward','insertFromPaste'].includes(e.inputType)) return;
        if (e.inputType.startsWith('insert')) { e.preventDefault(); }
      } else if (kind === 'comma'){
        // alleen comma of punt → normaliseren naar ','
        if (isComma){
          // vervang hele celinhoud door één komma
          e.preventDefault();
          c.textContent = ',';
          return;
        }
        // wis of leegmaken mag
        if (['deleteContentBackward','deleteContentForward','insertFromPaste'].includes(e.inputType)) return;
        // cijfers niet toegestaan in de komma-cel
        if (isDigit) { e.preventDefault(); return; }
        // overige input blokkeren
        if (e.inputType.startsWith('insert')) { e.preventDefault(); }
      }
    });

    // Trim naar max 1 teken in digit- of comma-cellen
    c.addEventListener('input', ()=>{
      const t = (c.textContent || '').trim();
      if (kind === 'digit' && t.length > 1) c.textContent = t.slice(-1);
      if (kind === 'comma' && t !== '' && t !== ',') c.textContent = ',';
    });

    return c;
  }

  /* ---------- Werkgebied: rijen + topline na product ---------- */
  function buildWorkArea(node, intLen, useDecimals, decSlots, extraRowsRule){
    clear(node);

    // Bepaal het aantal visuele kolommen links (incl. komma-kolom)
    const totalCols = intLen + (useDecimals ? 1 + decSlots : 0);

    // Stel exact dezelfde kolomset in (met smalle komma-kolom)
    const template = buildTemplateCols(intLen, useDecimals, decSlots);

    // #rijen: volgens basisregel + extra decimalenregel
    const rows = Math.max(0, extraRowsRule);

    for(let r=0; r<rows; r++){
      const row = document.createElement('div');
      row.className = 'workRow';
      row.style.gridTemplateColumns = template;

      for(let c=0; c<totalCols; c++){
        const cell = document.createElement('div');
        cell.className = 'wcell';
        cell.setAttribute('contenteditable','true');

        // Als dit een PRODUCT-rij is (even r: 0,2,4,...) laat dan de rest-rij eronder
        // de topline tekenen op de kolommen waar iets staat.
        cell.addEventListener('input', ()=> handleRowInput(node, row));
        cell.addEventListener('blur',  ()=> handleRowInput(node, row));

        row.appendChild(cell);
      }
      node.appendChild(row);
    }
  }

  function handleRowInput(workArea, productRow){
    const rows = Array.from(workArea.querySelectorAll('.workRow'));
    const rIdx = rows.indexOf(productRow);
    if (rIdx === -1 || rIdx % 2 !== 0) return;         // alleen product-rijen reageren
    const restRow = rows[rIdx+1];
    if (!restRow) return;

    // Reset toplines in de rest-rij
    restRow.querySelectorAll('.wcell').forEach(c=> c.classList.remove('topline'));

    // Zoek kolommen met inhoud in de product-rij
    const prodCells = Array.from(productRow.querySelectorAll('.wcell'));
    const usedIdxs = prodCells
      .map((c,i)=>({i, t:(c.textContent||'').trim()}))
      .filter(x=> x.t !== '')
      .map(x=> x.i);
    if (usedIdxs.length === 0) return;

    const first = Math.min(...usedIdxs);
    const last  = Math.max(...usedIdxs);

    // Zet topline in de rest-rij, exact onder de gebruikte productkolommen
    const restCells = Array.from(restRow.querySelectorAll('.wcell'));
    for(let i=first;i<=last;i++){
      if (restCells[i]) restCells[i].classList.add('topline');
    }
  }

  /* ---------- Aantal rijen met jouw regel ---------- */
  function baseRowRule(dividend, divisor){
    const s = String(dividend);
    const n = s.length;                 // #cijfers in het (integere) deeltal
    const firstDigit = parseInt(s[0],10);
    return (firstDigit >= divisor) ? (2*n) : (2*n - 2);
  }

  // Extra rijen voor decimalen: +6 – 2 × (#cijfers na de komma in de opgave) (nooit negatief)
  function decimalExtraRows(origDecCount){
    const extra = 6 - 2 * (origDecCount || 0);
    return Math.max(0, extra);
  }

  /* ---------- Alles samen ---------- */
  function newExercise(){
    const wantNoRemainder = (document.querySelector('input[name="rest"]:checked').value === 'zonder');
    const useDecimals = document.getElementById('toDecimals').checked;
    const decSlots = useDecimals ? 3 : 0;     // we voorzien max. drie decimaalvakken (0,001)

    const { dividend, divisor, origDecCount } = generateProblem(wantNoRemainder);

    // LINKS: deeltal (incl. komma-kolom super smal)
    const intLen = String(dividend).length;
    const visualColsLeft = buildDividendGrid(document.getElementById('grid'), dividend, useDecimals, decSlots);

    // RECHTS: deler + quotiënt (quotiënt met smalle komma-kolom)
    buildDivisorGrid(document.getElementById('divGrid'), divisor);
    buildQuotGrid(document.getElementById('quotGrid'), intLen, useDecimals, decSlots);

    // WERK: #rijen = basisregel + extra decimaal-ruimte
    const rows = baseRowRule(dividend, divisor) + decimalExtraRows(origDecCount);
    buildWorkArea(document.getElementById('workArea'), intLen, useDecimals, decSlots, rows);
  }

  /* ---------- Events ---------- */
  document.getElementById('btnNew').addEventListener('click', newExercise);
  document.getElementById('toDecimals').addEventListener('change', ()=>{
    newExercise();
    // Herteken hbar precies na render
    setTimeout(()=>{ document.getElementById('hbar').style.width = document.getElementById('quotGrid').getBoundingClientRect().width + 'px'; }, 0);
  });

  // Wissen: maak werkveld & quotiënt leeg + verwijder toplines
  document.getElementById('btnReset').addEventListener('click', ()=>{
    document.querySelectorAll('#workArea .wcell').forEach(c=>{
      c.textContent=''; c.classList.remove('topline');
    });
    document.querySelectorAll('#quotGrid .gridcell[contenteditable]').forEach(c=> c.textContent='');
  });

  // Init
  newExercise();
  // Zorg dat de horizontale bar exact past (na 1 render)
  setTimeout(()=>{ document.getElementById('hbar').style.width = document.getElementById('quotGrid').getBoundingClientRect().width + 'px'; }, 0);

})();
</script>

</body>
</html>
