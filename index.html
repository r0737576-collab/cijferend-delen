<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Staartdeling — met nakijkfunctie (1A+2A)</title>
<style>
:root{--ink:#000;--grid:#c8c8c8;--cell:38px;--commaW:10px;--vline:4px;--bar:4px;--accent:#1f6feb;--ok:#e8f5ea;--err:#fee2e2}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial;background:#f3f3f3;color:#000}
header,.toolbar{background:#fff;border-bottom:1px solid #ddd;padding:.8rem 1rem}
.toolbar{display:flex;flex-wrap:wrap;gap:.6rem;align-items:center}
.group{display:flex;gap:.4rem;align-items:center;background:#f1f1f1;border:1px solid #ddd;border-radius:.4rem;padding:.3rem .5rem}
button{padding:.45rem .7rem;border:1px solid #bbb;border-radius:.4rem;background:#fff;cursor:pointer}
button:hover{border-color:#000}
main{padding:1rem}
.board{background:#fff;border:1px solid #ddd;border-radius:.6rem;padding:1rem;max-width:980px;margin:auto}
.gridrow,.workRow{display:grid}
.gridcell,.wcell{height:var(--cell);border-right:1px solid var(--grid);border-bottom:1px solid var(--grid);display:flex;align-items:center;justify-content:center;font-weight:600;font-size:1.2rem}
.gridrow{border:1px solid var(--grid);border-right:none;border-bottom:none}
.gridcell:last-child,.wcell:last-child{border-right:none}
.gray{color:#888}
#gridWrapper{display:flex;align-items:flex-start;gap:.2rem}
#leftSide{display:flex;flex-direction:column;gap:.6rem}
#vline{width:var(--vline);background:#000;margin-left:.15rem;margin-right:.35rem;border-radius:2px;align-self:stretch}
#rightSide{display:flex;flex-direction:column;gap:.5rem;padding-top:.05rem}
#hbar{height:var(--bar);background:#000;border-radius:2px}
#workArea{display:flex;flex-direction:column;gap:.15rem}
.workRow{border-left:1px solid var(--grid)}
#workArea .workRow:first-child .wcell{border-top:1px solid var(--grid)}
.wcell[contenteditable="true"],.gridcell[contenteditable="true"]{outline:none;caret-color:var(--ink)}
.wcell[contenteditable="true"]:focus,.gridcell[contenteditable="true"]:focus{box-shadow:inset 0 0 0 2px var(--accent);background:#f7fbff}
.wcell.topline{position:relative}
.wcell.topline::before{content:"";position:absolute;left:-1px;right:-1px;top:-2px;border-top:3px solid #000}
.ok{background:var(--ok)!important}
.err{background:var(--err)!important}
#feedbackBar{position:sticky;bottom:0;background:#111;color:#fff;padding:.6rem 1rem;font-size:.95rem;line-height:1.3;border-top:3px solid #0a0a0a}
@media print{header,.toolbar,#feedbackBar{display:none!important}main{padding:0}.board{border:none}}
</style>
</head>
<body>
<header><h1>Staartdeling</h1></header>
<div class="toolbar">
  <div class="group">
    <label><input type="radio" name="rest" value="zonder" checked> uitkomst</label>
    <label><input type="radio" name="rest" value="met"> met rest</label>
  </div>
  <div class="group"><label><input type="checkbox" id="toDecimals"> tot 0,001</label></div>
  <div class="group"><label><input type="checkbox" id="enableCheck"> controle</label></div>
  <button id="btnNew">Nieuwe oefening</button>
  <button id="btnCheck">Nakijken</button>
  <button id="btnSolution">Oplossing</button>
  <button id="btnReset">Wissen</button>
</div>
<main>
  <section class="board">
    <div id="gridWrapper">
      <div id="leftSide">
        <div id="grid" class="gridrow"></div>
        <div id="workArea"></div>
      </div>
      <div id="vline"></div>
      <div id="rightSide">
        <div id="divGrid" class="gridrow"></div>
        <div id="hbar"></div>
        <div id="quotGrid" class="gridrow"></div>
      </div>
    </div>
  </section>
</main>
<div id="feedbackBar">Klaar voor nakijken. Vul product en rest in per stap. Klik vervolgens **Nakijken**. Klik op een fout gemarkeerde cel om de uitgebreide uitleg te zien.</div>
<script>
(()=>{
  const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
  const buildColumns=(n,commaIdx=-1)=>Array.from({length:n},(_,i)=>i===commaIdx?'var(--commaW)':'var(--cell)').join(' ');
  const clear=n=>{n.innerHTML=''};
  const showFeedback=msg=>{$('#feedbackBar').textContent=msg};
  const rnd=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;
  const settings={dividendMax:10000,divisorMax:20};
  function generateProblem(noRemainder){let d=rnd(2,settings.divisorMax);let N; if(noRemainder){const q=rnd(2,Math.max(2,Math.floor(settings.dividendMax/d)));N=d*q;}else{N=rnd(2,settings.dividendMax);if(N%d===0)N+=1;}return {dividend:N,divisor:d};}
  function buildDividendGrid(node, dividend, useDec){clear(node);const s=String(dividend);const intLen=s.length;const total=intLen+(useDec?1+3:0);node.style.gridTemplateColumns=buildColumns(total,useDec?intLen:-1);for(const ch of s){const c=document.createElement('div');c.className='gridcell';c.textContent=ch;node.appendChild(c);}if(useDec){const comma=document.createElement('div');comma.className='gridcell';comma.textContent=',';node.appendChild(comma);for(let i=0;i<3;i++){const z=document.createElement('div');z.className='gridcell gray';z.textContent='0';node.appendChild(z);}}return {intLen,totalCols:total,commaIndex:useDec?intLen:-1};}
  function buildDivisorGrid(node,divisor){clear(node);const s=String(divisor);node.style.gridTemplateColumns=buildColumns(s.length);for(const ch of s){const c=document.createElement('div');c.className='gridcell';c.textContent=ch;node.appendChild(c);}}
  let qState={cols:0,base:0,commaIdx:-1,maxExtraDec:3};
  function buildQuotGrid(node,intLen){clear(node);qState={cols:intLen,base:intLen,commaIdx:-1,maxExtraDec:3};node.dataset.intlen=String(intLen);node.style.gridTemplateColumns=buildColumns(qState.cols,qState.commaIdx);for(let i=0;i<qState.cols;i++){node.appendChild(makeQuotCell(i));}setupHBarAutoWidth(node);} 
  function makeQuotCell(idx){const c=document.createElement('div');c.className='gridcell';c.setAttribute('contenteditable','true');c.addEventListener('input',()=>{let t=(c.textContent||'').trim();const grid=$('#quotGrid');if([.,].test(t)){c.textContent=',';if(qState.commaIdx!==-1&&qState.commaIdx!==idx){const old=grid.children[qState.commaIdx];if(old) old.textContent='';}qState.commaIdx=idx;grid.style.gridTemplateColumns=buildColumns(qState.cols,qState.commaIdx);ensureOneExtraAfterComma();syncHBar();return;}t=t.replace(/\D+/g,'');if(t.length>1)t=t.slice(-1);c.textContent=t;if(qState.commaIdx===idx&&c.textContent!==','){qState.commaIdx=-1;trimToBase();}if(qState.commaIdx!==-1){growDecimalsIfNeeded();}syncHBar();});return c;}
  function ensureOneExtraAfterComma(){const extra=qState.cols-qState.base;if(extra<1&&qState.maxExtraDec>0) addQuotColumn();}
  function growDecimalsIfNeeded(){const grid=$('#quotGrid');const extra=qState.cols-qState.base;if(extra>=qState.maxExtraDec) return;const last=grid.children[grid.children.length-1];if(!last) return;const filled=((last.textContent||'').trim()!=='');if(filled) addQuotColumn();}
  function addQuotColumn(){const grid=$('#quotGrid');const extra=qState.cols-qState.base;if(extra>=qState.maxExtraDec) return;qState.cols+=1;grid.style.gridTemplateColumns=buildColumns(qState.cols,qState.commaIdx);grid.appendChild(makeQuotCell(qState.cols-1));}
  function trimToBase(){const grid=$('#quotGrid');while(grid.children.length>qState.base){grid.removeChild(grid.lastElementChild);}qState.cols=qState.base;grid.style.gridTemplateColumns=buildColumns(qState.cols,qState.commaIdx);}
  function setupHBarAutoWidth(quotNode){const hbar=$('#hbar');const ro=new ResizeObserver(()=>{hbar.style.width=quotNode.getBoundingClientRect().width+"px"});ro.observe(quotNode);} 
  function syncHBar(){const hbar=$('#hbar');hbar.style.width=$('#quotGrid').getBoundingClientRect().width+"px"}
  function baseRowRule(dividend,divisor){const s=String(dividend);const n=s.length;const first=parseInt(s[0],10);return (first>=divisor)?(2*n):(2*n-2);} 
  function buildWorkArea(node, dividend, divisor, useDec, totalColsLeft, commaIndexLeft){clear(node);const rows=baseRowRule(dividend,divisor)+6;for(let r=0;r<rows;r++){const row=document.createElement('div');row.className='workRow';row.style.gridTemplateColumns=buildColumns(totalColsLeft,useDec?commaIndexLeft:-1);for(let c=0;c<totalColsLeft;c++){const cell=document.createElement('div');cell.className='wcell';cell.setAttribute('contenteditable','true');cell.addEventListener('input',()=>handleRowInput(node,row));cell.addEventListener('blur',()=>handleRowInput(node,row));cell.addEventListener('click',()=>{const m=cell.dataset.msg||''; if(m) showFeedback(m);});row.appendChild(cell);}node.appendChild(row);} }
  function handleRowInput(workArea,productRow){const rows=Array.from(workArea.querySelectorAll('.workRow'));const rIdx=rows.indexOf(productRow);if(rIdx===-1||rIdx%2!==0) return;const restRow=rows[rIdx+1];if(!restRow) return;restRow.querySelectorAll('.wcell').forEach(c=>c.classList.remove('topline'));const prodCells=Array.from(productRow.querySelectorAll('.wcell'));const usedIdxs=prodCells.map((c,i)=>({i,t:(c.textContent||'').trim()})).filter(x=>x.t!=='').map(x=>x.i);if(usedIdxs.length===0) return;const first=Math.min(...usedIdxs), last=Math.max(...usedIdxs);const restCells=Array.from(restRow.querySelectorAll('.wcell'));for(let i=first;i<=last;i++){if(restCells[i]) restCells[i].classList.add('topline');}}
  // ====== Long division planner ======
  function planDivision(dividend, divisor, maxDec=3){const digs=String(dividend).split('').map(d=>+d);let steps=[];let idx=0, cur=0;let qInt=[];while(idx<digs.length){cur=cur*10+digs[idx];const qd=Math.floor(cur/divisor);const prod=qd*divisor;const rem=cur-prod;steps.push({digitIndex:idx, part:cur, qDigit:qd, prod:prod, rem:rem, isDec:false});qInt.push(qd);cur=rem;idx++;}
    let qDec=[];let dec=0;while(dec<maxDec && cur!==0){cur*=10;const qd=Math.floor(cur/divisor);const prod=qd*divisor;const rem=cur-prod;steps.push({digitIndex:idx+dec, part:cur, qDigit:qd, prod:prod, rem:rem, isDec:true, decIndex:dec+1});qDec.push(qd);cur=rem;dec++;}
    return {steps,qInt,qDec,finalRemainder:cur};}
  function mark(cell, ok, msg){cell.classList.remove('ok','err');cell.dataset.msg='';if(ok===true){cell.classList.add('ok');}else if(ok===false){cell.classList.add('err');cell.dataset.msg=msg||'';cell.addEventListener('click',()=>showFeedback(cell.dataset.msg),{once:false});}}
  function getCellTxt(cell){return (cell.textContent||'').trim();}
  function checkQuotient(dividend, divisor){const plan=planDivision(dividend,divisor,3);const qGrid=$('#quotGrid');const intLen=parseInt(qGrid.dataset.intlen,10);const cells=Array.from(qGrid.children);const commaIdx=qState.commaIdx;const wantNoRest=(document.querySelector('input[name="rest"]:checked').value==='zonder');
    // expected comma at after integer columns: index intLen-1 (since comma between int and first dec)
    if(commaIdx!==-1){const okComma=(commaIdx===intLen-1);for(let i=0;i<cells.length;i++){if(getCellTxt(cells[i])===','){mark(cells[i], okComma, okComma?'':'Kommapositie fout: komma moet na het '+intLen+'e quotiëntcijfer (tussen integer en decimalen)');}}
    }
    // per integer column compare qInt
    for(let i=0;i<intLen;i++){const exp=plan.qInt[i]??0;const got=getCellTxt(cells[i]);if(got===''){continue;} if(got===','){mark(cells[i], false, 'Komma staat in een cijfercel: vul hier een cijfer van het quotiënt'); continue;} const ok=(+got===exp);mark(cells[i], ok, ok?'':`Quotiëntcijfer fout op positie ${i+1}: floor(deelbaar/deler) = ${exp}`);} 
    // decimal cells: those after base length
    if(commaIdx!==-1){const decCells=cells.slice(intLen);for(let j=0;j<decCells.length && j<3;j++){const exp=plan.qDec[j];const got=getCellTxt(decCells[j]);if(got===''){continue;} const ok=(+got===exp);mark(decCells[j], ok, ok?'':`Decimaal ${j+1} fout: floor(rest×10 / ${divisor}) = ${exp}`);} 
      // Strict rule A: if rest != 0 and provided fewer than 3 decimals → error on last filled decimal or on comma cell
      if(plan.finalRemainder!==0){const filled=decCells.filter(c=>getCellTxt(c)!=='').length; if(filled<3){ const target = decCells[filled-1] || cells[commaIdx]; if(target) mark(target,false,`Deling niet af: rest = ${plan.finalRemainder} ≠ 0 → verder delen tot maximaal 3 decimalen`); }
      }
    return plan;}
  function checkWorkArea(dividend, divisor, useDec, leftTotalCols, plan){const rows=$$('#workArea .workRow'); // pairs: product row, rest row
    const intLen=String(dividend).length; const commaCol=useDec?intLen:-1; 
    // Build expected per step aligned to column digitIndex; for decimals, shift by +1 for comma column
    plan.steps.forEach((s, si)=>{const pairIdx=si*2; const prow=rows[pairIdx], rrow=rows[pairIdx+1]; if(!prow||!rrow) return; const prodStr=String(s.prod); const remStr=String(s.rem);
      // compute column where this step ends
      const colEnd = (s.isDec? ( (commaCol===-1? intLen : commaCol)+ s.decIndex ): s.digitIndex); const shift = (commaCol!==-1 && s.isDec)?1:0; const endCol = s.isDec? (commaCol + shift + s.decIndex): s.digitIndex; // after comma there is the narrow column + decimals
      const peStart = endCol-(prodStr.length-1); const reStart = endCol-(remStr.length-1);
      const pCells=Array.from(prow.children), rCells=Array.from(rrow.children);
      // mark product cells user filled
      for(let i=0;i<pCells.length;i++){const got=getCellTxt(pCells[i]); if(got==='') continue; let ok=false, msg=''; if(i>=peStart && i<=endCol){const k=i-peStart; ok=(got===prodStr[k]); msg = ok?'':`Product fout: ${s.qDigit} × ${divisor} = ${s.prod}, maar jij gaf ${got} op deze positie`; } else { ok=false; msg=`Cijfer van product staat in een verkeerde kolom (verwacht uitlijning rechts op kolom ${endCol+1})`; } mark(pCells[i], ok, msg); }
      // mark rest cells user filled
      for(let i=0;i<rCells.length;i++){const got=getCellTxt(rCells[i]); if(got==='') continue; let ok=false, msg=''; if(i>=reStart && i<=endCol){const k=i-reStart; ok=(got===remStr[k]); msg = ok?'':`Rest fout: ${s.part} − (${s.qDigit} × ${divisor}) = ${s.rem}, maar jij gaf ${got} op deze positie`; } else { ok=false; msg=`Cijfer van rest staat in een verkeerde kolom (verwacht uitlijning rechts op kolom ${endCol+1})`; } mark(rCells[i], ok, msg); }
      // extra rule: rest < divisor
      if(getCellTxt(rCells[reStart]||{})!==''){ const restVal = s.rem; if(restVal>=divisor){ const tgt = rCells[reStart]||rCells[endCol]; if(tgt) mark(tgt,false,`Rest te groot: rest (${restVal}) moet kleiner zijn dan deler (${divisor})`); }
      }
    });
  }
  // ====== Wire UI ======
  let current={dividend:0, divisor:0};
  function newExercise(){const noRest=(document.querySelector('input[name="rest"]:checked').value==='zonder');const useDec=$('#toDecimals').checked; current=generateProblem(noRest); const {intLen,totalCols,commaIndex}=buildDividendGrid($('#grid'), current.dividend, useDec); buildDivisorGrid($('#divGrid'), current.divisor); const qNode=$('#quotGrid'); qNode.dataset.intlen=String(intLen); buildQuotGrid(qNode,intLen); buildWorkArea($('#workArea'), current.dividend, current.divisor, useDec, totalCols, commaIndex); setTimeout(syncHBar,0); showFeedback('Klaar voor nakijken. Vul product en rest in per stap. Klik vervolgens **Nakijken**.'); $$(' .gridcell, .wcell ').forEach(c=>{c.classList.remove('ok','err'); c.dataset.msg='';}); }
  function resetAll(){ $$('#workArea .wcell').forEach(c=>{c.textContent='';c.classList.remove('ok','err','topline');c.dataset.msg='';}); const q=$('#quotGrid'); const intLen=parseInt(q.dataset.intlen,10)||1; buildQuotGrid(q,intLen); showFeedback('Velden gewist.'); }
  function doCheck(){ // remove previous marks
    $$('.ok,.err').forEach(c=>{c.classList.remove('ok','err'); c.dataset.msg='';}); const plan = checkQuotient(current.dividend,current.divisor); const useDec=$('#toDecimals').checked; const leftTotal=$('#grid').children.length; checkWorkArea(current.dividend,current.divisor,useDec,leftTotal,plan); showFeedback('Nakijken voltooid. Klik op een rood vakje om de uitleg te lezen.'); }
  $('#btnNew').addEventListener('click',newExercise);
  $('#toDecimals').addEventListener('change',newExercise);
  $('#btnReset').addEventListener('click',resetAll);
  $('#btnCheck').addEventListener('click',doCheck);
  // Oplossing-knop: voorlopig enkel melding
  $('#btnSolution').addEventListener('click',()=>{showFeedback('De oplossingsweergave wordt in een volgende stap toegevoegd.');});
  // init
  newExercise();
})();
</script>
</body>
</html>
