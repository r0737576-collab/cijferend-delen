<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Staartdeling — quotient met vaste celbreedte & groeiend aantal kolommen</title>

<style>
:root{
  --ink:#000;
  --grid:#c8c8c8;
  --cell:38px;      /* standaard cel */
  --vline:4px;      /* verticale dikke lijn */
  --bar:4px;        /* horizontale dikke lijn */
  --accent:#1f6feb; /* focuskleur */
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial;
  background:#f3f3f3; color:#000;
}

header, .toolbar{
  background:#fff; border-bottom:1px solid #ddd; padding:.8rem 1rem;
}
.toolbar{ display:flex; flex-wrap:wrap; gap:.6rem; align-items:center; }
.group{
  display:flex; gap:.4rem; align-items:center;
  background:#f1f1f1; border:1px solid #ddd; border-radius:.4rem;
  padding:.3rem .5rem;
}
button{
  padding:.45rem .7rem; border:1px solid #bbb; border-radius:.4rem; background:#fff; cursor:pointer;
}
button:hover{ border-color:#000; }

main{ padding:1rem; }
.board{
  background:#fff; border:1px solid #ddd; border-radius:.6rem; padding:1rem;
  max-width:980px; margin:auto;
}

/* ===== Raster (kolommen worden via JS gezet) ===== */
.gridrow, .workRow{ display:grid; }
.gridcell, .wcell{
  height:var(--cell);
  border-right:1px solid var(--grid);
  border-bottom:1px solid var(--grid);
  display:flex; align-items:center; justify-content:center;
  font-weight:600; font-size:1.2rem;
}
.gridrow { border:1px solid var(--grid); border-right:none; border-bottom:none; }
.gridcell:last-child, .wcell:last-child{ border-right:none; }
.gray{ color:#888; }

/* ===== Layout: [links(deeltal+werk)] | [vline] | [rechts(deler, balk, quotient)] ===== */
#gridWrapper{ display:flex; align-items:flex-start; gap:.2rem; }
#leftSide{ display:flex; flex-direction:column; gap:.6rem; }

/* verticale dikke lijn */
#vline{
  width:var(--vline); background:#000;
  margin-left:.15rem; margin-right:.35rem; border-radius:2px;
  align-self:stretch;
}

/* rechterzijde */
#rightSide{ display:flex; flex-direction:column; gap:.5rem; padding-top:.05rem; }
#hbar{ height:var(--bar); background:#000; border-radius:2px; }

/* ===== Werkveld (leeg & invulbaar, kolomopstelling) ===== */
#workArea{ display:flex; flex-direction:column; gap:.15rem; }
.workRow{ border-left:1px solid var(--grid); }
#workArea .workRow:first-child .wcell{ border-top:1px solid var(--grid); }

.wcell[contenteditable="true"], .gridcell[contenteditable="true"]{ outline:none; caret-color: var(--ink); }
.wcell[contenteditable="true"]:focus, .gridcell[contenteditable="true"]:focus{
  box-shadow: inset 0 0 0 2px var(--accent); background:#f7fbff;
}

/* trekstreep (alleen in REST-rij onder de product-rij) */
.wcell.topline{ position:relative; }
.wcell.topline::before{
  content:"";
  position:absolute; left:-1px; right:-1px; top:-2px;
  border-top:3px solid #000;
}

/* Print */
@media print{
  header,.toolbar{ display:none !important; }
  main{ padding:0 }
  .board{ border:none }
}
</style>
</head>

<body>

<header>
  <h1>Staartdeling</h1>
</header>

<!-- KNOPPENBALK (laten zoals eerder) -->
<div class="toolbar">
  <div class="group">
    <label><input type="radio" name="rest" value="zonder" checked> uitkomst</label>
    <label><input type="radio" name="rest" value="met"> met rest</label>
  </div>

  <div class="group"><label><input type="checkbox" id="toDecimals"> tot 0,001</label></div>
  <div class="group"><label><input type="checkbox" id="enableCheck"> controle</label></div>

  <button id="btnNew">Nieuwe oefening</button>
  <button id="btnCheck">Nakijken</button>
  <button id="btnSolution">Oplossing</button>
  <button id="btnReset">Wissen</button>
</div>

<main>
  <section class="board">
    <div id="gridWrapper">

      <!-- LINKS: deeltal + werk -->
      <div id="leftSide">
        <div id="grid" class="gridrow"></div>
        <div id="workArea"></div>
      </div>

      <!-- MIDDEN: verticale dikke lijn -->
      <div id="vline"></div>

      <!-- RECHTS: deler + horizontale lijn + quotient -->
      <div id="rightSide">
        <div id="divGrid" class="gridrow"></div>
        <div id="hbar"></div>
        <div id="quotGrid" class="gridrow"></div>
      </div>

    </div>
  </section>
</main>

<script>
(function(){

  const rnd = (a,b)=>Math.floor(Math.random()*(b-a+1))+a;
  const $  = s => document.querySelector(s);

  const settings = { dividendMax: 10000, divisorMax: 20 };

  /* ============== Opgave ============== */
  function generateProblem(wantNoRemainder){
    let divisor = rnd(2, settings.divisorMax);
    let dividend;
    if (wantNoRemainder){
      const q = rnd(2, Math.max(2, Math.floor(settings.dividendMax/divisor)));
      dividend = divisor*q;
    } else {
      dividend = rnd(2, settings.dividendMax);
      if (dividend % divisor === 0) dividend += 1;
    }
    return { dividend, divisor };
  }

  /* ============== Helpers ============== */
  function clear(n){ n.innerHTML=''; }
  function buildColumns(count){ return new Array(count).fill('var(--cell)').join(' '); }

  /* ============== Deeltal (links) ============== */
  // Links tonen we – als “tot 0,001” aan staat – komma + 3 nul‑cellen (visueel, voor referentie).
  function buildDividendGrid(node, dividend, useDecimals){
    clear(node);
    const s = String(dividend);
    const intLen = s.length;

    const totalCols = intLen + (useDecimals ? 1+3 : 0);
    node.style.gridTemplateColumns = buildColumns(totalCols);

    // Integere cijfers
    for(const ch of s){ const c=document.createElement('div'); c.className='gridcell'; c.textContent=ch; node.appendChild(c); }
    if (useDecimals){
      const comma=document.createElement('div'); comma.className='gridcell'; comma.textContent=','; node.appendChild(comma);
      for(let i=0;i<3;i++){ const z=document.createElement('div'); z.className='gridcell gray'; z.textContent='0'; node.appendChild(z); }
    }

    return { intLen, totalCols };
  }

  /* ============== Deler (rechts, boven balk) ============== */
  function buildDivisorGrid(node, divisor){
    clear(node);
    const s = String(divisor);
    node.style.gridTemplateColumns = buildColumns(s.length);
    for(const ch of s){
      const c=document.createElement('div');
      c.className='gridcell';
      c.textContent=ch;
      node.appendChild(c);
    }
  }

  /* ============== Quotient (rechts, onder balk) ============== */
  // ✨ Jouw eisen:
  //  • vaste celbreedte (geen smalle komma-kolom)
  //  • initieel #cellen = intLen (lengte van het deeltal)
  //  • in ELK vakje kan een komma (of punt) worden getypt; er is steeds maar één komma actief
  //  • zodra er een komma staat: +1 extra vakje
  //  • zodra het laatste decimaalvakje gevuld is: +1 extra vakje (tot max. 3 extra wanneer “tot 0,001” aan staat)
  let qState = { cols: 0, commaIdx: -1, maxExtraDec: 0 };

  function buildQuotGrid(node, intLen, allowDecimals){
    clear(node);
    qState = { cols: intLen, commaIdx: -1, maxExtraDec: allowDecimals ? 3 : 0 };

    node.style.gridTemplateColumns = buildColumns(qState.cols);

    for(let i=0;i<qState.cols;i++){
      node.appendChild(makeQuotCell(i));
    }
    setupHBarAutoWidth(node);
  }

  function makeQuotCell(idx){
    const c = document.createElement('div');
    c.className = 'gridcell';
    c.setAttribute('contenteditable','true');

    c.addEventListener('input', ()=>{
      let t = (c.textContent || '').trim();

      // Komma in elk vakje (of &gt; , .) → normaliseren en verplaatsen
      if (/[.,]/.test(t)){
        c.textContent = ','; // normaliseer
        // verwijder oudere komma (als die bestond)
        if (qState.commaIdx !== -1 && qState.commaIdx !== idx){
          const old = $('#quotGrid').children[qState.commaIdx];
          if (old) old.textContent = '';
        }
        qState.commaIdx = idx;

        // bij eerste komma: +1 kolom (als toegestaan)
        maybeEnsureOneMoreColumn();

        syncHBar();
        return;
      }

      // Anders: enkel het laatste cijfer bijhouden
      t = t.replace(/\D+/g,'');
      if (t.length>1) t = t.slice(-1);
      c.textContent = t;

      // Als dit vakje de huidige 'komma-kolom' was, maar geen komma meer bevat → komma weg
      if (qState.commaIdx === idx && c.textContent !== ','){
        qState.commaIdx = -1;
        // alle decimaal‑extra kolommen verwijderen
        trimAllExtraDecimals();
      }

      // Als er al een komma is, en het laatste vakje is gevuld → nog één kolom erbij (tot max)
      if (qState.commaIdx !== -1){
        maybeGrowDecimals();
      }

      syncHBar();
    });

    return c;
  }

  function maybeEnsureOneMoreColumn(){
    if (qState.maxExtraDec === 0) return;           // decimalen niet toegestaan
    const q = $('#quotGrid');
    if (qState.cols < q.children.length + 1){       // veiligheid (zou gelijk moeten zijn)
      qState.cols = q.children.length;
    }
    if ((qState.cols - baseQuotCols()) < 1){        // nog geen extra kolom na komma
      addQuotColumn();
    }
  }

  // basis = intLen (getal vóór komma)
  function baseQuotCols(){
    // base = huidige total - extra (komma telt *niet* apart mee in kolomtelling; het is gewoon inhoud van een vakje)
    // Omdat we vaste breedte vakjes gebruiken, blijft base simpelweg het 1e aantal dat we initieel gezet hebben.
    // We lezen het uit 'data-intlen' op #quotGrid (wordt gezet bij build).
    const intLen = parseInt($('#quotGrid').dataset.intlen, 10) || 0;
    return intLen;
  }

  function addQuotColumn(){
    // voeg 1 kolom toe aan grid + DOM
    const q = $('#quotGrid');
    qState.cols += 1;
    q.style.gridTemplateColumns = buildColumns(qState.cols);
    q.appendChild(makeQuotCell(qState.cols-1));
  }

  function maybeGrowDecimals(){
    const q = $('#quotGrid');
    const children = [...q.children];
    // Tel hoeveel extra kolommen we al bovenop intLen hebben
    const extra = qState.cols - baseQuotCols();
    if (extra >= (1 + qState.maxExtraDec)) return;  // 1 (minstens na komma) + maxExtraDec

    const last = children[qState.cols-1];
    if (!last) return;
    const t = (last.textContent || '').trim();
    if (t !== ''){  // laatste vakje is gevuld → nieuwe kolom erbij
      addQuotColumn();
    }
  }

  function trimAllExtraDecimals(){
    const q = $('#quotGrid');
    const base = baseQuotCols();
    // Verwijder alle kolommen bovenop 'base'
    while (q.children.length > base){
      q.removeChild(q.lastElementChild);
    }
    qState.cols = base;
    q.style.gridTemplateColumns = buildColumns(qState.cols);
  }

  function setupHBarAutoWidth(quotNode){
    const hbar = $('#hbar');
    const ro = new ResizeObserver(()=>{ hbar.style.width = quotNode.getBoundingClientRect().width + 'px'; });
    ro.observe(quotNode);
  }
  function syncHBar(){
    const hbar = $('#hbar');
    hbar.style.width = $('#quotGrid').getBoundingClientRect().width + 'px';
  }

  /* ============== Werkveld (links) ============== */
  // Regels die je eerder vroeg:
  //  • basis: (eerste cijfer ≥ deler) ? 2×n : 2×n − 2
  //  • +6 extra rijen (opgave zonder komma) ⇒ genoeg ruimte voor decimaal werken
  function baseRowRule(dividend, divisor){
    const s = String(dividend);
    const n = s.length;
    const first = parseInt(s[0],10);
    return (first >= divisor) ? (2*n) : (2*n - 2);
  }

  function buildWorkArea(node, dividend, divisor, useDecimals, leftCols){
    clear(node);

    const totalCols = leftCols; // dezelfde #kolommen als links
    const template = buildColumns(totalCols);
    const rows = baseRowRule(dividend, divisor) + 6;

    for(let r=0;r<rows;r++){
      const row = document.createElement('div');
      row.className = 'workRow';
      row.style.gridTemplateColumns = template;
      for(let c=0;c<totalCols;c++){
        const cell=document.createElement('div');
        cell.className='wcell';
        cell.setAttribute('contenteditable','true');

        // Alleen product-rijen (even r) laten de rest-rij eronder de topline tekenen
        cell.addEventListener('input', ()=> handleRowInput(node, row));
        cell.addEventListener('blur',  ()=> handleRowInput(node, row));

        row.appendChild(cell);
      }
      node.appendChild(row);
    }
  }

  function handleRowInput(workArea, productRow){
    const rows = Array.from(workArea.querySelectorAll('.workRow'));
    const rIdx = rows.indexOf(productRow);
    if (rIdx === -1 || rIdx % 2 !== 0) return; // enkel product-rijen
    const restRow = rows[rIdx+1];
    if (!restRow) return;

    restRow.querySelectorAll('.wcell').forEach(c=> c.classList.remove('topline'));

    const prodCells = Array.from(productRow.querySelectorAll('.wcell'));
    const usedIdxs = prodCells
      .map((c,i)=>({i, t:(c.textContent||'').trim()}))
      .filter(x=> x.t!=='')
      .map(x=> x.i);
    if (usedIdxs.length===0) return;

    const first = Math.min(...usedIdxs);
    const last  = Math.max(...usedIdxs);

    const restCells = Array.from(restRow.querySelectorAll('.wcell'));
    for(let i=first;i<=last;i++){
      if (restCells[i]) restCells[i].classList.add('topline');
    }
  }

  /* ============== Samenstellen ============== */
  let current = { dividend:0, divisor:0 };

  function newExercise(){
    const wantNoRemainder = (document.querySelector('input[name="rest"]:checked').value === 'zonder');
    const useDecimals = document.getElementById('toDecimals').checked;

    current = generateProblem(wantNoRemainder);

    // LINKS (deeltal)
    const { intLen, totalCols } = buildDividendGrid($('#grid'), current.dividend, useDecimals);

    // RECHTS (deler + quotient)
    buildDivisorGrid($('#divGrid'), current.divisor);
    const qNode = $('#quotGrid');
    qNode.dataset.intlen = String(intLen);          // basis #kolommen voor quotient
    buildQuotGrid(qNode, intLen, useDecimals);

    // Werkveld
    buildWorkArea($('#workArea'), current.dividend, current.divisor, useDecimals, totalCols);

    setTimeout(syncHBar, 0);
  }

  /* ============== Events ============== */
  $('#btnNew').addEventListener('click', newExercise);
  $('#toDecimals').addEventListener('change', newExercise);

  $('#btnReset').addEventListener('click', ()=>{
    // werkveld leeg
    document.querySelectorAll('#workArea .wcell').forEach(c=>{ c.textContent=''; c.classList.remove('topline'); });
    // quotient resetten naar basis (intLen)
    const q = $('#quotGrid');
    const intLen = parseInt(q.dataset.intlen,10) || 1;
    buildQuotGrid(q, intLen, document.getElementById('toDecimals').checked);
  });

  // Start
  newExercise();

})();
</script>

</body>
</html>
